# 通知・リマインド機能改善計画

## 概要
通知とリマインド機能に関する4つの問題を修正します。

## 問題点と修正内容

### 1. 無限通知が機能しない 🔥【最優先】

**問題**:
- 通知を無視したままアプリを開かないと、5回配信後に通知が停止する
- `NotificationActionHandler.scheduleNextReminderAfterDelivery`が1件ずつしか追加しない
- `NotificationRefreshService`が呼ばれないため、通知バッファが補充されない

**修正内容**:
- `scheduleNextReminderAfterDelivery`で`NotificationRefreshService.refreshNotifications()`を呼び出す
- 通知タップ時（アクションボタン以外）も同様に`refreshNotifications()`を呼び出す
- これにより常に5件の通知バッファを維持

**影響ファイル**:
- `Moriminder/Services/NotificationActionHandler.swift`

---

### 2. 繰り返しタスクの通知メッセージに日時情報がない

**問題**:
- 繰り返しタスクで「どの回についてのリマインドか」が分からない
- すべての通知が同じタイトル・本文

**修正内容**:
- 繰り返しタスクの通知メッセージに日時を追記
  - **形式**: 「タスク名 (3/15 14:00)」
  - タスク名が先、その後に日時（ユーザー要望）
  - できるだけ短縮形式（M/d HH:mm）
- アラーム・リマインド両方に適用

**影響ファイル**:
- `Moriminder/Services/NotificationManager.swift`

---

### 3. リマインドの「何分前」表示がない

**問題**:
- 現在は「60分間隔」としか表示されない
- いつの予定のどれくらい前にリマインドが始まるのか不明

**修正内容**:

#### 3-1. 通知メッセージ本文
- **現在**: 「カテゴリ: ○○」
- **変更後**: 「期限の60分前（30分間隔）」または「開始時刻の60分前（30分間隔）」

#### 3-2. タスクカード（一覧画面）
- **現在**: 「リマインド: 60分間隔」
- **変更後**: 「リマインド: 60分前・30分間隔」

#### 3-3. 編集画面リマインド設定
- 開始時刻Pickerの下に説明テキストを追加
  - 例: 「期限の60分前から開始」または「開始時刻の60分前から開始」

**影響ファイル**:
- `Moriminder/Services/NotificationManager.swift` (通知本文)
- `Moriminder/Views/TaskList/TaskCardView.swift` (タスクカード)
- `Moriminder/Views/TaskEdit/ReminderSettingView.swift` (編集画面)
- `Moriminder/Extensions/Task+Extensions.swift` (ヘルパー関数追加)

**追加ヘルパー関数**:
```swift
extension Task {
    // リマインド開始時刻が基準日時の何分前か計算
    func reminderStartOffsetMinutes() -> Int?

    // リマインドの基準（「期限」or「開始時刻」）を返す
    func reminderTargetDescription() -> String
}
```

---

### 4. アラーム設定UIが複雑 ⏸️【保留】

**問題**:
- 現在は任意の日時を設定可能だが、実際には期限時刻か開始時刻しか使わない

**判断**: 今回は修正しない

**理由**:
- 「開始時刻にアラーム + 期限時刻にリマインド」のユースケースが存在
- 開始時刻・期限時刻それぞれへのリマインド機能は設定が複雑化
- 仕様の深掘りが必要

**提案**: 別issueとして仕様を固めてから実装

---

## 実装順序

1. **無限通知修正**（最優先・アプリの核心価値）
2. **繰り返しタスク通知メッセージ**
3. **リマインド「何分前」表示**
   - ヘルパー関数追加
   - 通知メッセージ本文
   - タスクカード
   - 編集画面

---

## テスト項目

- [ ] 通知を5回以上無視してもリマインドが継続することを確認
- [ ] 繰り返しタスクの通知に正しい日時が表示されることを確認
- [ ] タスクカード・編集画面・通知で「何分前」が正しく表示されることを確認
- [ ] 期限のみ設定時は「期限の○分前」、開始時刻のみ設定時は「開始時刻の○分前」と表示されることを確認
- [ ] 両方設定時は優先順位（開始時刻 > 期限）で表示されることを確認

---

## 進捗管理

### ✅ 完了
- 無限通知修正（NotificationActionHandler.swift, MoriminderApp.swift）
  - NotificationRefreshService.refreshNotifications()を通知配信時・タップ時に呼び出すよう修正
  - 5件の通知バッファを常に維持する仕組みを実装
- 繰り返しタスク通知メッセージ（NotificationManager.swift）
  - formatNotificationTitle()ヘルパー関数を追加
  - アラーム・リマインダー通知のタイトルに日時情報（M/d HH:mm形式）を追加
- ヘルパー関数追加（Task+Extensions.swift）
  - reminderTargetDate: リマインド基準日時を返すプロパティ
  - reminderTargetDescription: 「期限」「開始時刻」の名称を返すプロパティ
  - reminderStartOffsetMinutes(): 何分前にリマインド開始か計算するメソッド
- リマインド「何分前」表示 - 通知本文（NotificationManager.swift）
  - 通知本文に「期限の60分前（30分間隔）」形式の情報を追加
- リマインド「何分前」表示 - タスクカード（TaskCardView.swift）
  - 「リマインド: 60分前・30分間隔」形式に変更
- リマインド「何分前」表示 - 編集画面（ReminderSettingView.swift）
  - DatePickerの下に「期限の60分前から開始」などの説明テキストを追加

### 🚧 作業中
- なし

### ⏳ 未着手
- なし

---

## 備考

- アラーム機能については、将来的に「開始時刻・期限時刻それぞれへのリマインド設定」を検討する可能性あり
- 通知メッセージの日時形式は「M/d HH:mm」で統一（短縮形式）
