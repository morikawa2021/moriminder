# Moriminder 要求仕様書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Moriminder（モリマインダー）

### 1.2 目的
リマインド通知を何度もスヌーズしてしまい、結局タスクを実行せずに忘れてしまう人のために、通知を無視しにくく、タスクを確実に実行できるようにサポートするタスク管理アプリを提供すること。

### 1.3 プラットフォーム
iOS（iPhone）

### 1.4 設計方針
- **シンプルさの重視**: 操作を極力シンプルに保つ
- **思考負荷の軽減**: 入力の負担だけでなく、ユーザーが考える負担も少なくする
- **実行支援の充実**: タスク実行や予定忘れ防止をサポートする機能は充実させる

---

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 TODO登録機能
- **概要**: ユーザーがタスクまたはスケジュールを登録できる
- **TODOの種類**:
  - **タスク**: 期限までに作業を完了させる性質のもの
    - 期限日時を設定（任意）
    - 期限が来る前に完了できる
  - **スケジュール**: 決まった日時に行う行動（その時刻が来ないと着手できないもの）
    - 開始日時を設定（任意）
    - 開始日時前は完了操作時に警告を表示するが、完了は可能
- **詳細**:
  - タスク名（必須）
  - カテゴリ（任意、後述のカテゴリ機能参照）
  - 重要度（任意、後述の重要度機能参照）
  - 日時設定（任意）
    - 「期限」または「開始日時」を選択
    - デフォルトは「期限」
    - 両方設定することも可能（開始日時と期限の両方）
      - 両方設定した場合、リマインドは期限を優先して動作する
        - リマインド設定は期限ベースの設定（タスクの場合の設定）を適用する
        - 重要度が設定されている場合、タスクの場合のデフォルト設定（例: 高重要度なら1時間間隔）を適用する
        - スケジュールの段階的リマインド設定は適用されない
      - 完了制限も期限を優先する（期限前は完了可能、開始日時前でも完了可能）
      - タスク一覧では両方の日時を表示する
  - アラーム設定（任意）
  - リマインド設定（任意、重要度に応じたデフォルト値が自動適用）
- **自然言語日時解析機能**:
  - タスク名入力時に日時情報を自動抽出・解析
  - 対応可能なパターン（Foundation の NSDataDetector を使用）:
    - 基本的な日時表現: 「2025年1月15日」「1月15日」「15日」
    - 時刻表現: 「午後3時」「15時」「3:00 PM」
    - 相対的な日付: 「明日」「来週」「次の月曜日」（NSDataDetector の対応範囲内）
  - 制限事項:
    - 複雑な日本語表現（「再来週の水曜日」「3日後の午後」など）は検出できない可能性がある
    - 「まで」「に」などのキーワードでタスク/スケジュールを判定（完璧ではない）
    - 誤検出の可能性があるため、抽出結果は必ずユーザーに確認を求める
  - 例（成功する可能性が高い）: 「明日 午後3時 会議」→ 開始日時を自動設定
  - 例（成功する可能性が高い）: 「1月15日まで 提出」→ 期限を自動設定
  - 音声入力にも対応（Siriショートカット連携）
  - 解析結果を確認してから適用可能（必須）
  - 自然言語解析で日時が抽出された場合、プリセット時間ピッカーには抽出された日時が反映される
  - 自然言語解析とプリセット時間ピッカーの両方が利用可能で、ユーザーが選択・修正可能
- **UI要件**:
  - 最小限の入力で登録できる
  - デフォルト値や推奨設定を提供し、思考負荷を軽減
  - 日時設定の種類（期限/開始日時）は明確に区別できるUIで選択
  - 自然言語から日時を抽出した場合、抽出結果を視覚的に表示し、承認・修正可能

#### 2.1.2 アラーム機能
- **概要**: 指定した時刻にアラームを鳴らす
- **詳細**:
  - アラーム時刻の設定（日時指定）
  - アラーム音の設定（デフォルト音あり）
  - アラームのON/OFF切り替え
- **動作**:
  - 設定時刻になるとアラームが鳴る
  - アラームを停止するまで継続
- **アラームとリマインドの両方設定時**:
  - アラームとリマインドは独立して動作する
  - アラーム時刻とリマインド時刻が重複した場合でも、両方の通知が送信される
  - アラームは一度だけ通知し、リマインドは設定間隔で繰り返し通知する

#### 2.1.3 リマインド機能
- **概要**: 重要度に応じたデフォルト設定で、リマインドを繰り返し通知する（間隔は分単位で設定可能）
- **iOS通知システムの制限**: iOSでは1アプリあたり最大64個のローカル通知しかスケジュールできない制約があります
  - この制限に対応するため、動的スケジューリング方式を採用（詳細は詳細仕様書を参照）
  - 直近の通知のみをスケジュールし、アプリ起動時やバックグラウンドタスクで次の通知を追加
  - 複数のタスクがある場合でも、全体で64個の制限内で動作するよう調整
- **重要度に基づくデフォルト設定**:
  - **低**:
    - タスクの場合: 毎日1回リマインド（24時間間隔）
    - スケジュールの場合: 開始日時までの残り時間に応じて段階的にリマインド頻度を上げる（頻度は低め）
      - 3日前から: 1日1回
      - 1日前から: 12時間間隔
      - 6時間前から: 6時間間隔
      - 1時間前から: 1時間間隔
      - 開始日時を過ぎた場合: 30分間隔でリマインド継続
  - **中**:
    - タスクの場合: 3時間に1回リマインド（180分間隔）
    - スケジュールの場合: 開始日時までの残り時間に応じて段階的にリマインド頻度を上げる（適度な頻度）
      - 1週間前から: 1日1回
      - 3日前から: 1日2回（12時間間隔）
      - 1日前から: 6時間間隔
      - 6時間前から: 3時間間隔
      - 3時間前から: 1時間間隔
      - 1時間前から: 30分間隔
      - 開始日時を過ぎた場合: 15分間隔でリマインド継続
  - **高**: 
    - タスクの場合: 1時間に1回リマインド（60分間隔）
    - スケジュールの場合: 開始日時までの残り時間に応じて段階的にリマインド頻度を上げる（頻度は高め）
      - 1週間前から: 1日1回
      - 3日前から: 1日2回（12時間間隔）
      - 1日前から: 6時間間隔
      - 6時間前から: 3時間間隔
      - 3時間前から: 1時間間隔
      - 1時間前から: 30分間隔
      - 30分前から: 15分間隔
      - 15分前から: 5分間隔
      - 5分前から: 1分間隔
      - 開始日時を過ぎた場合: 1分間隔でリマインド継続
- **詳細**:
  - 重要度が設定されている場合、デフォルトで上記のリマインド設定が自動適用される
  - ユーザーはデフォルト設定を変更可能
  - 重要度が設定されていない場合、リマインド設定は手動で設定する必要がある
  - リマインド間隔の設定（分単位、例: 5分、10分、15分、30分、60分など）
  - リマインド開始時刻の設定（任意）
    - タスク（期限設定）の場合: デフォルトは即座
    - スケジュール（開始日時設定）の場合: デフォルトは開始日時の前からリマインドを開始
      - 重要度が設定されている場合: 上記の段階的リマインド設定に従い、開始日時の前からリマインドを開始
      - 重要度が設定されていない場合: 手動設定に従う（デフォルトは開始日時の前からリマインドを開始、具体的な間隔は手動設定）
    - 開始日時と期限の両方が設定されている場合: 期限を優先し、タスク（期限設定）の場合の設定を適用する
  - リマインド終了時刻の設定（任意、デフォルトはタスク完了まで）
    - スケジュール（開始日時設定）の場合、開始日時を過ぎた後もリマインドが継続する設定がある場合、リマインド終了時刻が設定されていればその時刻で終了、設定されていなければタスク完了まで継続
    - 開始日時と期限の両方が設定されている場合: 期限を優先し、期限ベースのリマインド設定を適用する
  - リマインドのON/OFF切り替え
- **アラームとリマインドの両方設定時**:
  - アラームとリマインドは独立して動作する
  - アラーム時刻とリマインド時刻が重複した場合でも、両方の通知が送信される
  - アラームは一度だけ通知し、リマインドは設定間隔で繰り返し通知する
- **動作**:
  - 設定間隔でプッシュ通知を送信
  - タスクが完了するか、ユーザーがリマインドを停止するまで継続
  - スケジュール（開始日時設定）の場合、開始日時の前からリマインドを開始
    - 重要度が設定されている場合: 上記の段階的リマインド設定に基づいて、開始日時までの残り時間に応じて自動的にリマインド間隔を変更
    - 重要度が設定されていない場合: 手動設定に従う（デフォルトは開始日時の前からリマインドを開始、具体的な間隔は手動設定）
- **UI要件**:
  - よく使う間隔をプリセットとして提供（5分、15分、30分、1時間など）
  - 重要度を設定すると、デフォルトのリマインド設定が自動的に表示される
  - デフォルト設定をそのまま使用するか、カスタマイズするかを選択可能
  - **操作の制御**:
  - **スヌーズ機能**: 通知を簡単にスヌーズできる（ワンタップで次のリマインドまで一時停止）
    - **注意**: スヌーズ最大回数は通知スケジュール時ではなく、通知が配信された後にユーザーが「スヌーズ」ボタンを押した時に適用される
    - スヌーズの繰り返し回数を設定可能（スヌーズを何回まで繰り返せるかを設定）
      - デフォルト: 5回までスヌーズ可能（重要度に応じて変更可能）
      - 最大: 10回までスヌーズ可能
      - 無期限スヌーズオプション（期限超過アイテムに対して）
    - スヌーズカウンターのリセットタイミング:
      - タスク完了時: カウンターをリセット
      - 日付が変わった時点（午前0時）: カウンターをリセット（新しい日として扱う）
        - 実装: `Calendar.current.startOfDay(for: Date())`を使用して日付判定
        - 最後のスヌーズ日時と現在日時の「日付部分」を比較
        - 日付が異なればカウンターを0にリセット
      - 通知アクションでスヌーズした場合もカウントに含める
      - 実装例:
        ```swift
        // スヌーズ実行前にリセット判定
        let today = Calendar.current.startOfDay(for: Date())
        let lastSnoozeDate = Calendar.current.startOfDay(for: task.lastSnoozeDateTime ?? Date.distantPast)

        if today > lastSnoozeDate {
            // 日付が変わったのでカウンターをリセット
            task.snoozeCount = 0
        }

        // スヌーズを実行
        task.snoozeCount += 1
        task.lastSnoozeDateTime = Date()
        ```
    - アプリ起動時や通知操作時に自動スヌーズを実行可能
  - **完了・終了の制限**: タスクの完了やリマインドの完全停止は簡単にできないようにする
    - 完了時は確認ダイアログを表示（「本当に完了しますか？」など）
      - タスク一覧のスワイプ完了でも確認ダイアログを表示
      - 通知からの完了アクションでも確認ダイアログを表示
      - アプリ内詳細画面からの完了でも確認ダイアログを表示
    - リマインド停止時も確認ダイアログを表示
    - 未完了のまま完了にしてしまうことを防ぐため、簡単な操作（ワンタップ）では完了・停止できない
    - スヌーズと完了・停止のUIを明確に区別する（色、位置、サイズで差別化）

#### 2.1.4 繰り返しタスク機能
- **概要**: 定期的に発生するタスクやスケジュールを繰り返し登録する
- **繰り返しパターン**:
  - **基本パターン**:
    - 毎日
    - 毎週（特定の曜日を選択可能）
    - 毎月（特定の日を選択可能）
    - 毎年
  - **複雑なパターン**:
    - 毎月第N曜日（例: 毎月第3水曜日）
    - N日ごと（例: 3日ごと、1週間ごと）
    - カスタムパターン（例: 平日のみ、週末のみ）
- **詳細**:
  - 繰り返し設定の有効化/無効化
  - 繰り返しの終了日時を設定可能（任意）
  - 繰り返しタスクの完了履歴を記録
  - 各繰り返しインスタンスを個別に完了・編集・削除可能
- **動作**:
  - 設定したパターンに従って、自動的に次のタスク/スケジュールを生成
  - 各インスタンスは独立して管理される
  - リマインド設定は各インスタンスに継承される
    - 重要度が設定されている場合: 各インスタンスにも重要度が継承され、重要度に応じたデフォルトのリマインド設定が自動適用される
    - 重要度が設定されていない場合: 元のタスクのリマインド設定を継承
- **UI要件**:
  - 繰り返しパターンの選択が簡単にできる
  - よく使うパターンをプリセットとして提供
  - 繰り返しタスクであることを視覚的に表示

#### 2.1.5 タスク完了機能
- **概要**: タスクまたはスケジュールを完了としてマークする
- **詳細**:
  - タスク完了のマーク
  - 完了日時の記録
  - 完了したタスクの表示/非表示切り替え
- **完了時の動作**:
  - タスクを完了すると、関連するアラーム・リマインドが自動的に停止
  - リマインドが設定されているタスクの完了時は、確認ダイアログを表示（未完了のまま完了にしてしまうことを防ぐため）
  - 完了確認後、リマインドが停止される
  - スケジュール（開始日時設定）の場合、開始日時前の完了時も同様に確認ダイアログを表示
- **スケジュール（開始日時設定）の完了制限**:
  - 開始日時前は完了操作時に警告を表示するが、完了は可能（警告を確認した上で完了できる）
  - 開始日時以降は通常通り完了できる
  - 開始日時と期限の両方が設定されている場合、完了制限は期限を優先する（期限前は完了可能）

### 2.2 高度な機能

#### 2.2.1 タスク細分化支援機能
- **概要**: 1週間以上完了しないタスクに対して、細分化を促し、自動的に提案する
- **トリガー条件**:
  - タスクが登録されてから1週間（7日）以上経過
    - 繰り返しタスクの場合、各インスタンスごとに登録日時からカウントする
  - タスクが未完了のまま
  - リマインドが継続的に送信されている（または送信されていた）
- **動作**:
  1. 条件を満たしたタスクに対して、細分化を促す通知を送信
  2. 通知をタップすると、細分化提案画面を表示
  3. LLM（大規模言語モデル）を呼び出して、タスクを細分化した案を自動生成・提案
  4. ユーザーは提案された細分化案を承認、修正、または却下できる
- **細分化提案の方法**:
  - LLM APIを呼び出してタスク名を解析し、一般的な作業ステップに分解
  - 例: 「部屋の掃除」→「床を掃除機でかける」「窓を拭く」「ゴミを捨てる」など
  - ネットワーク接続が必要（LLM API呼び出しのため）
  - ネットワーク接続エラー時は、エラーメッセージを表示し、再試行を促す
- **使用量制限とコスト管理**:
  - 1つのタスクにつき、細分化は1回のみ実行可能
    - 細分化実行後、同じタスクで再度細分化ボタンを表示しない
    - 細分化から生成されたサブタスクは、さらに細分化可能
  - 1日あたりの細分化回数制限: 5回まで
    - APIコスト高騰を防ぐため
    - 制限に達した場合、翌日0時にリセット
  - リトライ回数制限: 1回の細分化につき最大3回まで
    - ネットワークエラーやタイムアウトの場合のみリトライ可能
    - API エラー（クォータ超過など）の場合はリトライ不可
  - APIキーの管理:
    - 開発者がアプリに埋め込む（限定配布のため問題なし）
    - 将来的にユーザー自身のAPIキーを設定可能にすることも検討
- **UI要件**:
  - 提案は視覚的に分かりやすく表示
  - ワンタップで承認できる
  - 修正も簡単にできる
  - LLM処理中はローディング表示を表示
  - ネットワーク接続エラー時は適切なエラーメッセージを表示
  - 使用量制限に達した場合、明確なメッセージを表示（「本日の細分化回数上限に達しました。明日再度お試しください。」）

#### 2.2.2 カテゴリ機能
- **概要**: TODOにカテゴリを付与できる
- **詳細**:
  - カテゴリの選択機能
    - 既存のカテゴリから選択
    - カテゴリ一覧を表示（よく使うカテゴリを上位に表示）
  - カテゴリの新規作成機能
    - 存在しないカテゴリ名を入力すると、自動的に新規カテゴリとして登録
    - 明示的な「新規作成」操作は不要
  - カテゴリの管理機能
    - カテゴリ一覧の表示
    - カテゴリの編集・削除（任意）
- **UI要件**:
  - カテゴリ入力はオートコンプリート対応
  - よく使うカテゴリを上位に表示
  - カテゴリの色分け表示（視覚的な識別）

#### 2.2.3 重要度機能
- **概要**: TODOに重要度を設定し、リマインド頻度のデフォルト値を自動適用する
- **重要度のレベル**:
  - **低**: 優先度の低いタスク・スケジュール
  - **中**: 通常のタスク・スケジュール
  - **高**: 重要なタスク・スケジュール（忘れてはいけない事柄、重要な予定）
- **詳細**:
  - 重要度の選択機能
    - 3段階（低、中、高）から選択
    - デフォルトは「中」または未設定
  - 重要度に応じたリマインド設定の自動適用
    - 重要度を設定すると、リマインド機能のデフォルト設定が自動的に適用される
    - ユーザーはデフォルト設定をそのまま使用するか、カスタマイズ可能
- **半自動的な判断**（将来の拡張機能として検討）:
  - カテゴリやタスク名から重要度を自動推定する機能
  - ユーザーの過去の設定パターンから重要度を推奨する機能
- **UI要件**:
  - 重要度は視覚的に分かりやすく表示（星マーク、色分けなど）
  - 重要度を設定すると、デフォルトのリマインド設定が自動的に表示される
  - デフォルト設定をそのまま使用するか、カスタマイズするかを簡単に選択可能

### 2.3 表示・管理機能

#### 2.3.1 タスク一覧表示
- **概要**: 登録されたタスクまたはスケジュールを一覧表示する
- **表示項目**:
  - タスク名
  - カテゴリ（あれば）
  - 重要度（あれば）
  - 日時情報（期限または開始日時、設定されていれば）
    - タスク（期限設定）の場合: 「期限: YYYY/MM/DD HH:mm」のように表示
    - スケジュール（開始日時設定）の場合: 「開始: YYYY/MM/DD HH:mm」のように表示
    - 両方設定されている場合: 「開始: YYYY/MM/DD HH:mm / 期限: YYYY/MM/DD HH:mm」のように両方表示
  - アラーム時刻（設定されていれば）
  - リマインド設定（設定されていれば）
  - 繰り返し設定（繰り返しタスクの場合、繰り返しアイコンで表示）
  - 登録日時
  - 完了状態
- **表示モード**:
  - 全タスク表示
  - 未完了タスクのみ表示
  - 完了タスクのみ表示
  - カテゴリ別フィルタ
  - 重要度別フィルタ（任意）
  - タスク/スケジュール別フィルタ（任意）
- **ソート機能**:
  - 登録日時順（新着順/古い順）
  - 重要度順（高→中→低）
  - 期限順（期限設定のタスク）
  - 開始日時順（開始日時設定のスケジュール）
  - アラーム時刻順
  - カテゴリ順
  - アルファベット順

#### 2.3.2 タスク編集・削除機能
- **概要**: 登録済みのタスクまたはスケジュールを編集・削除できる
- **詳細**:
  - タスク名の編集
  - カテゴリの変更
  - 重要度の変更
  - 日時設定の変更（期限/開始日時の変更、種類の変更も可能）
  - 繰り返し設定の変更（繰り返しタスクの場合）
  - アラーム設定の変更
  - リマインド設定の変更
  - タスクの削除
- **日時設定の種類変更時の動作**:
  - **タスク（期限設定）からスケジュール（開始日時設定）への変更**:
    - 既存のリマインド設定は保持されるが、重要度が設定されている場合は新しい種類に応じたデフォルト設定を提案
    - ユーザーは既存設定を維持するか、新しいデフォルト設定に変更するかを選択可能
    - 完了制限が適用される（開始日時前は完了操作時に警告を表示するが、完了は可能）
    - 既存のリマインド通知は、新しい設定に基づいて再スケジュールされる
  - **スケジュール（開始日時設定）からタスク（期限設定）への変更**:
    - 既存のリマインド設定は保持されるが、重要度が設定されている場合は新しい種類に応じたデフォルト設定を提案
    - ユーザーは既存設定を維持するか、新しいデフォルト設定に変更するかを選択可能
    - 完了制限が解除される（期限前でも完了可能）
    - 既存のリマインド通知は、新しい設定に基づいて再スケジュールされる
  - **日時設定の両方設定時**:
    - リマインドは期限を優先して動作する
      - リマインド設定は期限ベースの設定（タスクの場合の設定）を適用する
      - 重要度が設定されている場合、タスクの場合のデフォルト設定（例: 高重要度なら1時間間隔）を適用する
      - スケジュールの段階的リマインド設定は適用されない
    - 完了制限も期限を優先する（期限前は完了可能）
    - タスク一覧では両方の日時を表示する
  - **重要度の変更時**:
    - 日時設定の種類（タスク/スケジュール）に応じた新しいデフォルト設定を提案
    - ユーザーは既存設定を維持するか、新しいデフォルト設定に変更するかを選択可能

---

## 3. 非機能要件

### 3.1 パフォーマンス
- アプリ起動時間: 3秒以内
- タスク登録処理: 1秒以内
- 通知の遅延: 設定時刻の±1分以内
- LLM API呼び出し（タスク細分化）: 10秒以内（タイムアウト設定）
  - ネットワーク状況により変動する可能性があるため、ローディング表示でユーザーに待機を促す

### 3.2 ユーザビリティ
- **操作のシンプルさ**:
  - 主要操作は3タップ以内で完了
  - デフォルト値や推奨設定を提供
  - 不要な確認ダイアログを避ける
- **視認性**:
  - フォントサイズはiOSのアクセシビリティ設定に対応
  - コントラスト比を適切に保つ
- **フィードバック**:
  - 操作に対して適切な視覚的・触覚的フィードバックを提供

### 3.3 通知機能
- **プッシュ通知**:
  - iOSのローカル通知を使用
  - 通知権限の適切な要求
  - 通知のカスタマイズ（音、バッジ、アラート）
  - **通知の重要度設定**:
    - iOSの通知重要度を設定（通知を無視しにくくする）
      - iOSのUserNotificationsフレームワーク（iOS 15+）で設定可能な範囲で、通知の重要度を調整
      - 重要度「高」: 時間に敏感な通知（interruptionLevel: .timeSensitive）
        - Focus Mode（集中モード）でも表示される可能性が高い
        - 通知サマリーの上位に表示
      - 重要度「中」: 通常の通知（interruptionLevel: .active）
        - 標準的な通知として表示
      - 重要度「低」: 控えめな通知（interruptionLevel: .passive）
        - 通知サマリーに追加される
    - 複数の通知が独立して管理される（通知センターで個別に表示）
    - 通知センターから一括で消えない仕組み（可能な限り実現）
    - **注**: Critical Alerts（.critical）は健康・安全関連アプリのみが使用可能な特別な権限であり、
      タスク管理アプリでは使用できません。Time Sensitive 通知で十分な効果が得られます。
- **通知の管理**:
  - 通知の一括管理機能
  - 通知履歴の表示（任意）

### 3.4 データ管理
- **データ保存**:
  - ローカルストレージ（Core DataまたはSwiftData）
  - iCloud同期（将来の拡張機能として検討）
- **データの永続化**:
  - アプリを再起動してもデータが保持される
  - バックアップ・復元に対応

### 3.5 セキュリティ・プライバシー
- ユーザーデータは端末内に保存
- タスク細分化機能でLLM APIを呼び出す際に、タスク名のみを外部サービスに送信
  - 送信前にユーザーに明示的に通知（初回利用時など）
  - プライバシーポリシーでデータ送信について明記
  - タスク名以外の個人情報は送信しない

---

## 4. UI/UX要件

### 4.1 画面構成

#### 4.1.1 メイン画面（タスク一覧）
- **レイアウト**:
  - タスク一覧を中央に配置
  - 上部にフィルタ・ソート機能
  - 下部に「新規タスク追加」ボタン（固定）
- **タスクカード**:
  - タスク名を大きく表示
  - カテゴリを色付きバッジで表示
  - 重要度を視覚的に表示（星マーク、色分けなど）
  - 期限または開始日時を表示（設定されている場合）
    - タスク（期限設定）: 「期限」ラベルと日時を表示
    - スケジュール（開始日時設定）: 「開始」ラベルと日時を表示
    - 両方設定されている場合: 「開始」と「期限」の両方のラベルと日時を表示
  - アラーム・リマインド設定をアイコンで表示
  - 繰り返しタスクであることを視覚的に表示（繰り返しアイコンなど）
  - スワイプで完了/削除操作
    - **完了操作**: リマインド設定の有無に関わらず、常に確認ダイアログを表示
      - 確認ダイアログで「本当に完了しますか？」と確認
      - スケジュール（開始日時設定）の場合、開始日時前は追加の警告も表示
    - **削除操作**: 確認ダイアログを表示（「本当に削除しますか？」）
  - 開始日時と期限の両方が設定されている場合、完了制限は期限を優先する

#### 4.1.2 タスク登録・編集画面
- **レイアウト**:
  - タスク名入力欄（最上部、大きく）
  - カテゴリ選択（オートコンプリート付きテキストフィールド）
  - 重要度選択（低、中、高から選択、デフォルトは「中」または未設定）
  - 日時設定セクション（折りたたみ可能）
    - 「期限」または「開始日時」を選択（セグメントコントロールまたはタブ）
    - プリセット時間ピッカーを提供
      - よく使う時間を12個程度プリセット（例: 今日の9時、今日の12時、今日の15時、今日の18時、明日の9時など）
      - プリセット時間はワンタップで選択可能（日付と時間の両方を設定）
      - ユーザーがカスタマイズ可能（よく使う時間を設定）
      - カスタム時間も設定可能（日時ピッカーで詳細設定）
    - デフォルトは「期限」
    - 編集時は現在の設定（期限/開始日時）が選択状態で表示される
    - 自然言語入力から日時を抽出した場合、抽出結果を表示
  - アラーム設定セクション（折りたたみ可能）
  - 繰り返し設定セクション（折りたたみ可能、繰り返しタスクの場合）
    - 繰り返しパターンの選択
    - 繰り返しの終了日時の設定（任意）
  - リマインド設定セクション（折りたたみ可能）
    - 重要度が設定されている場合、デフォルトのリマインド設定が自動表示される
    - 「デフォルト設定を使用」または「カスタマイズ」を選択可能
    - 日時設定の種類（期限/開始日時）を変更した場合、新しい種類に応じたデフォルト設定を提案
    - ユーザーは既存設定を維持するか、新しいデフォルト設定に変更するかを選択可能
    - スヌーズの繰り返し回数設定（スヌーズを何回まで繰り返せるかを設定、デフォルト5回、最大10回、無期限オプション）
  - 保存ボタン
- **入力支援**:
  - タスク名の入力候補（過去のタスク名から）
  - カテゴリのオートコンプリート
  - よく使う設定のクイック選択
  - 日時設定の種類（期限/開始日時）は視覚的に明確に区別
  - 重要度を設定すると、リマインド設定のデフォルト値が自動的に表示される
  - 日時設定の種類を変更すると、リマインド設定のデフォルト値が自動的に更新される（重要度が設定されている場合）
  - 自然言語入力から日時を抽出した場合、抽出結果を表示して承認・修正可能
  - プリセット時間をワンタップで選択可能

#### 4.1.3 細分化提案画面
- **レイアウト**:
  - 元のタスク名を表示
  - LLM処理中はローディング表示
  - 提案された細分化タスクをリスト表示
  - 各タスクにチェックボックス
  - 「承認」「修正」「却下」ボタン
- **エラーハンドリング**:
  - ネットワーク接続エラー時はエラーメッセージを表示
  - 「再試行」ボタンを表示
  - ネットワーク接続がない場合は、接続を促すメッセージを表示

#### 4.1.4 通知画面・通知アクション
- **通知表示**:
  - リマインド通知にはタスク名とカテゴリを表示
  - 通知の重要度を適切に設定（通知を無視しにくくする）
  - iOSの通知重要度を高く設定し、通知センターで独立して表示
  - 複数の通知が同時に存在し、個別に管理される
- **通知アクション**:
  - **スヌーズ**: ワンタップで簡単にスヌーズできる（次のリマインドまで一時停止）
  - **完了**: 完了ボタンは表示するが、タップすると確認ダイアログを表示
  - **停止**: リマインド停止ボタンも表示するが、タップすると確認ダイアログを表示
  - **アプリを開く**: 通知をタップするとアプリを開き、タスク詳細画面を表示
- **UI設計**:
  - スヌーズボタンは目立つ位置に配置（簡単に操作できる）
  - 完了・停止ボタンはスヌーズボタンと視覚的に区別（色や位置で区別）
  - 未完了のまま完了にしてしまうことを防ぐため、完了・停止は確認が必要

### 4.2 デザイン原則
- **ミニマリズム**: 必要最小限の要素のみ表示
- **一貫性**: iOSのデザインガイドラインに準拠
- **アクセシビリティ**: VoiceOver対応、動的タイプ対応

---

## 5. 技術要件

### 5.1 開発環境
- **言語**: Swift
- **フレームワーク**: SwiftUI（推奨）または UIKit
- **最低iOSバージョン**: iOS 15.0以上
- **開発ツール**: Xcode 14.0以上

### 5.2 使用技術
- **通知**: UserNotifications フレームワーク
- **データ保存**: Core Data または SwiftData
- **日時処理**: Foundation の Date/Calendar
- **自然言語処理**: Foundation の DateFormatter、NSDataDetector（自然言語日時解析用）
- **音声入力**: Siriショートカット連携（音声入力からのタスク登録）
- **ネットワーク通信**: URLSession フレームワーク（LLM API呼び出し用）

### 5.3 外部ライブラリ
- 可能な限り標準ライブラリを使用
- 必要に応じて軽量なライブラリを検討

---

## 6. 配布方法

### 6.1 想定する配布形態
本アプリは一般公開（App Store公開）を目的とせず、開発者が選択した限定的なユーザー（3-5名程度の家族・友人）への配布を想定する。

### 6.2 配布方法のオプション

#### 6.2.1 オプション1: Xcode 直接インストール（開発期間中）
**対象:** 開発・初期テスト段階

**特徴:**
- Apple Developer Program 契約不要（コスト: ¥0）
- 証明書の有効期限: 7日間
- 7日ごとにXcodeから再ビルド&インストールが必要
- デバイスをMacに物理的に接続する必要あり

**運用方法:**
- 週1回の「リフレッシュデー」を設定し、一斉に再インストール
- 所要時間: 3-5名で5-10分程度

**適しているケース:**
- 開発期間中のテスト（開発者自身、または同居家族のみ）
- コストを最小限にしたい場合

#### 6.2.2 オプション2: TestFlight 配布（リリース後・推奨）
**対象:** アプリ完成後、継続的に使用する段階

**特徴:**
- Apple Developer Program 契約が必要（年間 ¥12,980）
- 証明書の有効期限: 1年間
- メールで招待リンクを送るだけで配布可能
- 更新も TestFlight 経由で簡単に配信
- 最大100名の外部テスター

**運用方法:**
1. Xcode でアーカイブを作成
2. App Store Connect にアップロード
3. 家族・友人のメールアドレスを招待
4. 招待された人が TestFlight アプリからインストール
5. 更新時も TestFlight 経由で自動配信

**適しているケース:**
- アプリが完成し、継続的に使用する段階
- 遠方の家族・友人も含めた配布
- 頻繁な更新を予定している場合

### 6.3 推奨される段階的アプローチ
1. **開発段階（1-2ヶ月想定）**: オプション1（無料）で開始
   - 開発者自身、または同居家族でテスト
   - 週1回の再インストールで運用
2. **リリース後**: オプション2（TestFlight）へ移行
   - アプリが完成し、継続利用の価値が確認できた段階で Apple Developer Program に加入
   - 遠方の家族・友人を含めた配布が可能になる

### 6.4 配布方法と機能の関係
両配布方法とも、本アプリの全機能（Time Sensitive 通知を含む）が利用可能。
App Store 公開を想定しないため、実験的な機能や独自の工夫も自由に実装できる。

---

## 7. 将来の拡張機能（Phase 2以降）

### 7.1 検討中の機能
- iCloud同期
- ウィジェット表示
- Apple Watch対応
- Siriショートカット対応（音声入力からのタスク登録は実装済み、その他の高度な機能は将来の拡張）
- 統計・分析機能（タスク完了率など）
- タスクテンプレート機能

---

## 8. 制約事項

### 8.1 技術的制約
- iOS専用（Android版は別プロジェクト）
- 基本機能はオフライン動作可能（タスク登録、アラーム、リマインドなど）
- タスク細分化機能はネットワーク接続が必要（LLM API呼び出しのため）
  - ネットワーク接続がない場合、細分化機能は利用不可
  - その他の機能はネットワーク接続なしでも動作

### 8.2 ビジネス制約
- App Store での公開・販売は想定しない（家族・友人への限定配布）
- 開発期間中は無料アカウントで運用、リリース後は Apple Developer Program（年間 ¥12,980）への加入を検討
- 広告は表示しない

---

## 9. 用語定義

- **TODO**: ユーザーが登録するタスクまたはスケジュール
- **タスク**: 期限までに作業を完了させる性質のもの
- **スケジュール**: 決まった日時に行う行動（その時刻が来ないと着手できないもの）
- **期限**: タスクを完了すべき日時
- **開始日時**: スケジュールを開始すべき日時
- **アラーム**: 指定した時刻に一度だけ通知する機能
- **リマインド**: 指定した間隔で繰り返し通知する機能
- **カテゴリ**: タスクを分類するためのラベル
- **重要度**: タスクやスケジュールの重要度を表す指標（低、中、高の3段階）
- **細分化**: 大きなタスクを小さなタスクに分割すること
- **繰り返しタスク**: 定期的に発生するタスクやスケジュールを自動的に生成する機能
- **自然言語日時解析**: テキスト入力や音声入力から日時情報を自動抽出する機能
- **プリセット時間**: よく使う時間をワンタップで選択できるようにした設定
- **LLM**: 大規模言語モデル（Large Language Model）。タスク細分化機能で使用

---

## 10. 参考資料

- iOS Human Interface Guidelines
- Apple Developer Documentation
- SwiftUI Documentation

---

## 11. 変更履歴

| 日時 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2025-11-09 02:17 | 1.0 | 初版作成 | - |
| 2025-11-09 03:01 | 1.1 | レビューに基づく修正:<br>- Critical Alerts を Time Sensitive に変更<br>- 配布方法セクションを新規追加（Xcode直接/TestFlight）<br>- iOS通知64個制限への対応を明記<br>- 自然言語解析の対応範囲を明確化<br>- LLM API使用量制限とコスト管理を追加<br>- スヌーズ管理ロジックとUI/UX一貫性を改善 | - |
| 2025-11-09 03:37 | 1.2 | レビュー指摘事項への対応:<br>- スヌーズカウンターのリセット条件を明確化（日付が変わった時点＝午前0時）<br>- Calendar.current.startOfDay を使用した実装例を追加 | - |

