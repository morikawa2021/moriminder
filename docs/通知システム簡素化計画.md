# 通知システム簡素化計画

> **関連ドキュメント:** [通知・リマインド改善計画](./通知・リマインド改善計画.md)
>
> 本ドキュメントは「通知・リマインド改善計画」の「4. アラーム設定UIが複雑」で保留とされた課題を深掘りし、アラームとリマインドの統合について検討した設計書です。

## 課題
- 現在「アラーム」と「リマインド」が別々の概念として存在
- アラームはリマインドに統合できるのでは？という疑問
- ただし「開始時刻通知 + 期限前リマインド」など複数の時間ポイントへの通知が必要

## 結論：時間ポイント別の統一通知モデル

### コアコンセプト

**「リマインドを有効にすれば、その時刻への通知は当然含まれる」**

各時間ポイント（開始時刻・期限）に対して：
- **通知のみ**: その時刻に1回だけ通知
- **リマインド**: 前から繰り返し通知 → **その時刻に最終通知**（自動的に含まれる）

これにより「アラーム」という別概念が不要になる。

### 新しい概念モデル

```
タスクの時間ポイント:
├── 開始時刻 (startDateTime)
│   ├── 通知のみ: 開始時刻に1回通知
│   └── リマインド: 開始前から繰り返し → 開始時刻に最終通知
│
└── 期限 (deadline)
    ├── 通知のみ: 期限に1回通知
    └── リマインド: 期限前から繰り返し → 期限に最終通知
```

### ユースケース対応表

| ユースケース | 設定 |
|-------------|------|
| 締め切りに1回通知 | 期限「通知のみ」 |
| 締め切り前からリマインド | 期限「リマインド」（最後に期限時刻の通知も届く） |
| 会議開始時に1回通知 | 開始「通知のみ」 |
| 会議準備リマインド + 開始通知 | 開始「リマインド」（前から繰り返し→開始時刻に最終通知） |
| 開始通知 + 終了通知 | 開始「通知のみ」+ 期限「通知のみ」 |
| 準備リマインド + 終了リマインド | 開始「リマインド」+ 期限「リマインド」 |

### UI設計

```
[日時設定]
  開始時刻: [2024/01/15 14:00]
  期限:     [2024/01/15 15:00]

[通知設定]

  ── 開始時刻 (14:00) ──────────────────
  （開始時刻が設定されている場合のみ表示）

  ○ 通知しない
  ○ 開始時刻に通知（1回のみ）
  ● リマインドする
      └ [30] 分前から / [10分] 間隔
        ℹ️ 13:30から10分間隔で通知、14:00に最終通知

  ── 期限 (15:00) ──────────────────────
  （期限が設定されている場合のみ表示）

  ○ 通知しない
  ● 期限に通知（1回のみ）
  ○ リマインドする
      └ [60] 分前から / [15分] 間隔
```

**ポイント:**
- 3つの選択肢（通知なし / 1回通知 / リマインド）
- リマインド選択時は「前からの繰り返し + 時刻の最終通知」がセット
- 時間ポイントごとに独立して設定可能
- 各セクションは対応する時刻が設定されている場合のみ表示

### リマインド終了ルール

| 条件 | 開始時刻リマインドの終了 | 期限リマインドの終了 |
|-----|------------------------|-------------------|
| 開始時刻のみ設定 | タスク完了まで継続 | - |
| 期限のみ設定 | - | タスク完了まで継続 |
| 両方設定 | **開始時刻で終了** | タスク完了まで継続 |

**ルールの理由:**
- 期限がある場合、期限のリマインドが主役なので開始時刻リマインドは開始時刻で役目終了
- 期限がない場合、開始時刻のリマインドがタスク完了を促す役割を担う

### データモデル

**現在のモデル（廃止）:**
```swift
alarmEnabled: Bool
alarmDateTime: Date?
alarmSound: String?
reminderEnabled: Bool
reminderStartTime: Date?
reminderInterval: Int
reminderEndTime: Date?
```

**新モデル:**
```swift
// 開始時刻に対する通知設定
enum NotificationType: String {
    case none       // 通知なし
    case once       // 1回のみ（その時刻に通知）
    case remind     // リマインド（繰り返し + 最終通知）
}

startTimeNotification: String       // NotificationType: "none", "once", "remind"
startTimeReminderOffset: Int        // 何分前から（デフォルト: 30）
startTimeReminderInterval: Int      // 間隔（分、デフォルト: 10）

// 期限に対する通知設定
deadlineNotification: String        // NotificationType: "none", "once", "remind"
deadlineReminderOffset: Int         // 何分前から（デフォルト: 60）
deadlineReminderInterval: Int       // 間隔（分、デフォルト: 15）
```

### 通知スケジューリングロジック

```swift
func scheduleNotifications(for task: Task) {
    // 開始時刻の通知
    if let startDateTime = task.startDateTime {
        switch task.startTimeNotification {
        case .once:
            // 開始時刻に1回通知
            scheduleOnceNotification(at: startDateTime, type: .startTime)
        case .remind:
            // 開始前からリマインド + 開始時刻に最終通知
            scheduleReminders(
                target: startDateTime,
                offset: task.startTimeReminderOffset,
                interval: task.startTimeReminderInterval,
                type: .startTime
            )
            scheduleOnceNotification(at: startDateTime, type: .startTimeFinal)
        case .none:
            break
        }
    }

    // 期限の通知
    if let deadline = task.deadline {
        switch task.deadlineNotification {
        case .once:
            scheduleOnceNotification(at: deadline, type: .deadline)
        case .remind:
            scheduleReminders(
                target: deadline,
                offset: task.deadlineReminderOffset,
                interval: task.deadlineReminderInterval,
                type: .deadline
            )
            scheduleOnceNotification(at: deadline, type: .deadlineFinal)
        case .none:
            break
        }
    }
}
```

### マイグレーション

既存データの変換ルール:
```
旧: alarmEnabled=true, alarmDateTime=X
→ 新: X が startDateTime に近い場合 → startTimeNotification=.once
      X が deadline に近い場合 → deadlineNotification=.once

旧: reminderEnabled=true, reminderStartTime=Y, reminderInterval=Z
→ 新: 基準時刻を特定（startDateTime or deadline）
      → 該当のNotification=.remind, Offset=計算値, Interval=Z
```

## 実装手順

### Phase 1: データモデル更新
1. Task エンティティに新しい属性を追加
2. NotificationType enum 追加
3. マイグレーション処理を実装

### Phase 2: サービス層更新
1. NotificationManager のスケジューリングロジック変更
2. ReminderService の更新（時間ポイント別対応）
3. 通知カテゴリの整理

### Phase 3: ViewModel更新
1. TaskEditViewModel のプロパティ変更
2. バインディング更新

### Phase 4: UI更新
1. 新しい NotificationSettingView を作成（時間ポイント別セクション）
2. AlarmSettingView, ReminderSettingView を統合
3. TaskEditView の更新

### Phase 5: テスト・ドキュメント
1. 単体テスト
2. 仕様書更新

## 影響ファイル

- `Mamorunder.xcdatamodeld` - Core Data モデル
- `Task+CoreDataProperties.swift` - エンティティプロパティ
- `NotificationManager.swift` - 通知スケジューリング
- `ReminderService.swift` - リマインドロジック
- `TaskEditViewModel.swift` - ViewModel
- `AlarmSettingView.swift` - 廃止 → NotificationSettingView に統合
- `ReminderSettingView.swift` - 廃止 → NotificationSettingView に統合
- `TaskEditView.swift` - 編集画面
- `docs/詳細仕様書.md` - 仕様書
